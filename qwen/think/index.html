<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>讨论实验</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<style>
.markdown-body h1,h2,h3 { font-weight:600; margin:8px 0; }
.markdown-body code { padding:2px 4px; border-radius:4px; }
.markdown-body pre { background:#0f172a; color:#e2e8f0; padding:10px; border-radius:6px; overflow:auto; }
.markdown-body ul { list-style:disc; margin-left:20px; }
.markdown-body p { margin:6px 0; }
</style>

<body class="bg-slate-100 text-slate-800 font-sans">

<div class="max-w-6xl mx-auto p-6 space-y-6">

    <h1 class="text-3xl font-bold text-center">话题讨论实验</h1>

    <div class="bg-white p-4 rounded-xl shadow space-y-3">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input id="authInput" placeholder="Auth Key" class="border p-2 rounded"/>
            <input id="hostInput" placeholder="Host 地址" class="border p-2 rounded"/>
            <button onclick="testConnection()" class="bg-indigo-600 text-white rounded px-4">检测连接</button>
        </div>
        <div id="connStatus" class="text-sm"></div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow space-y-4">

        <textarea title="promptA" id="promptA" class="w-full border rounded p-2 h-20">你是一个理性、严谨、喜欢举例论证的AI。</textarea>
        <textarea title="promptB" id="promptB" class="w-full border rounded p-2 h-20">你是一个善于反驳、提出新观点的AI。</textarea>
        <textarea title="topic" id="topic" class="w-full border rounded p-2 h-20">人工智能是否会取代程序员？</textarea>

        <div class="flex items-center gap-4">
            <button onclick="start()" class="bg-blue-600 text-white px-4 py-2 rounded">开始</button>
            <button onclick="nextStep()" class="bg-green-600 text-white px-4 py-2 rounded">继续</button>
            <label class="flex items-center gap-2">
                <input type="checkbox" id="autoRun"> 自动运行
            </label>
            <button onclick="clearChat()" class="bg-gray-500 text-white px-4 py-2 rounded">清空</button>
            <button onclick="exportJson()" class="bg-purple-600 text-white px-4 py-2 rounded">导出 JSON</button>
        </div>
    </div>

    <!-- 聊天区 -->
    <div id="chat" class="bg-white p-6 rounded-xl shadow h-[500px] overflow-y-auto space-y-4"></div>

</div>

<script>
function getAuth(){ return document.getElementById("authInput").value.trim(); }
function getHost(){ return document.getElementById("hostInput").value.trim(); }

const urlParams = new URLSearchParams(location.search);
document.getElementById("authInput").value = urlParams.get("auth") || "";
document.getElementById("hostInput").value = urlParams.get("host") || "http://localhost:5000";

async function testConnection(){
    const auth = getAuth();
    const host = getHost();
    const status = document.getElementById("connStatus");

    if(!auth || !host){
        status.innerHTML = `<span class="text-red-600">请填写 Auth 和 Host</span>`;
        return;
    }

    try{
        const res = await fetch(`${host}/Main/models`, {
            headers: { "Auth": auth }
        });
        if(res.ok){
            status.innerHTML = `<span class="text-green-600">连接成功 ✓</span>`;
        }else{
            status.innerHTML = `<span class="text-red-600">连接失败: ${res.status}</span>`;
        }
    }catch(e){
        status.innerHTML = `<span class="text-red-600">无法连接服务器</span>`;
    }
}

let sessionA, sessionB;
let running=false, turn="A", lastMessage="";
let history=[];

function createMessageBubble(role){
    const div = document.createElement("div");
    div.className = role === "A"
        ? "bg-blue-50 p-3 rounded border-l-4 border-blue-400"
        : "bg-green-50 p-3 rounded border-l-4 border-green-400";

    div.innerHTML = `<b>AI ${role}：</b><div class="markdown-body mt-2"></div>`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;

    return div.querySelector(".markdown-body");
}


async function createSession(){
    const res = await fetch(`${getHost()}/Main/sessions`, {
        method: "POST",
        headers: { "Auth": getAuth() }
    });

    const json = await res.json();
    console.log("创建会话返回：", json);

    if(!json.id){
        throw new Error("创建会话失败，未返回 id");
    }

    return json.id;
}


async function sendMessage(id, content, role){
    const res = await fetch(`${getHost()}/Main/sessions/${id}/messages`, {
        method: "POST",
        headers: {
            "Auth": getAuth(),
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ Content: content })
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder();

    let text = "";
    const container = createMessageBubble(role);

    while(true){
        const {done, value} = await reader.read();
        if(done) break;

        text += decoder.decode(value, {stream:true});

        // ⭐ 实时 Markdown 渲染
        container.innerHTML = marked.parse(text);
        chat.scrollTop = chat.scrollHeight;
    }

    history.push({role, text});
    return text;
}


async function start(){
    chat.innerHTML="";
    history=[];
    running=true;

    sessionA = await createSession();
    sessionB = await createSession();

    console.log("SessionA:", sessionA);
    console.log("SessionB:", sessionB);

    if(!sessionA || !sessionB){
        alert("会话创建失败，请检查接口返回");
        running=false;
        return;
    }

    lastMessage = document.getElementById("promptA").value +
        "\n讨论话题：" + document.getElementById("topic").value;

    turn="A";

    if(autoRun.checked) loop();
}


async function nextStep(){
    if(!running) return;
    await step();
}

async function loop(){
    while(running && autoRun.checked){
        await step();
        await new Promise(r=>setTimeout(r,500));
    }
}

async function step(){
    if(turn==="A"){
        const reply = await sendMessage(sessionA, lastMessage, "A");
        lastMessage = reply;
        turn = "B";
    }else{
        const reply = await sendMessage(
            sessionB,
            document.getElementById("promptB").value + "\n" + lastMessage,
            "B"
        );
        lastMessage = reply;
        turn = "A";
    }
}


function clearChat(){
    chat.innerHTML="";
    history=[];
}

function exportJson(){
    const blob=new Blob([JSON.stringify(history,null,2)],{type:"application/json"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="ai-discussion.json";
    a.click();
}
</script>

</body>
</html>
