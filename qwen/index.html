<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QwenWebAPI 调试工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        neutral: '#64748B',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-thin {
                scrollbar-width: thin;
            }
            .scrollbar-none {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .scrollbar-none::-webkit-scrollbar {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-dark">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="mb-8">
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-primary mb-2">QwenWebAPI 调试工具</h1>
            <p class="text-neutral mb-4">通过此页面可以调用QwenWebAPI的所有接口</p>
            
            <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-neutral mb-1">API基础地址</label>
                        <input type="text" title="inpt" id="baseUrl" value="http://localhost:5000" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-neutral mb-1">Auth认证密钥</label>
                        <input type="text" title="inpt" id="authKey" readonly
                            class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                </div>
                <div class="mt-3 text-sm text-neutral">
                    <p>Auth参数将从URL查询字符串中获取，格式: <code class="bg-gray-100 px-1 py-0.5 rounded">?auth=你的密钥</code></p>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md overflow-hidden sticky top-4">
                    <div class="p-4 bg-gray-50 border-b border-gray-200">
                        <h2 class="font-semibold text-lg">接口列表</h2>
                    </div>
                    <div class="p-2 max-h-[calc(100vh-240px)] overflow-y-auto scrollbar-thin">
                        <!-- 会话列表 -->
                        <div class="mb-1">
                            <button onclick="selectApi('getSessions')" class="w-full p-3 text-left hover:bg-gray-50 rounded transition flex items-center gap-2">
                                <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs font-medium">GET</span>
                                <span>/sessions</span>
                            </button>
                        </div>
                        
                        <!-- 模型列表 -->
                        <div class="mb-1">
                            <button onclick="selectApi('getModels')" class="w-full p-3 text-left hover:bg-gray-50 rounded transition flex items-center gap-2">
                                <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs font-medium">GET</span>
                                <span>/models</span>
                            </button>
                        </div>
                        
                        <!-- 新会话 -->
                        <div class="mb-1">
                            <button onclick="selectApi('createSession')" class="w-full p-3 text-left hover:bg-gray-50 rounded transition flex items-center gap-2">
                                <span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs font-medium">POST</span>
                                <span>/sessions</span>
                            </button>
                        </div>
                        
                        <!-- 会话历史 -->
                        <div class="mb-1">
                            <button onclick="selectApi('getSessionHistory')" class="w-full p-3 text-left hover:bg-gray-50 rounded transition flex items-center gap-2">
                                <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs font-medium">GET</span>
                                <span>/sessions/{sessionId}</span>
                            </button>
                        </div>
                        
                        <!-- 发送消息 -->
                        <div class="mb-1">
                            <button onclick="selectApi('sendMessage')" class="w-full p-3 text-left hover:bg-gray-50 rounded transition flex items-center gap-2">
                                <span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs font-medium">POST</span>
                                <span>/sessions/{sessionId}/messages</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div id="apiDetails">
                        <h2 class="text-xl font-semibold mb-4" id="apiTitle">请选择一个接口</h2>
                        
                        <div id="apiParams" class="space-y-4">
                            <!-- 接口参数 -->
                        </div>
                        
                        <div class="mt-6">
                            <button onclick="executeApi()" 
                                class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-md transition flex items-center gap-2">
                                <i class="fa fa-play"></i>
                                <span>执行请求</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 响应结果 -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">响应结果</h2>
                        <div class="flex gap-2">
                            <button onclick="copyResponse()" 
                                class="text-neutral hover:text-primary transition p-2">
                                <i class="fa fa-copy"></i> 复制
                            </button>
                            <button onclick="clearResponse()" 
                                class="text-neutral hover:text-primary transition p-2">
                                <i class="fa fa-trash"></i> 清空
                            </button>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <div id="responseStatus" class="mb-2 px-3 py-1 text-sm rounded inline-block hidden"></div>
                        <pre id="responseBody" class="bg-gray-50 p-4 rounded-md overflow-x-auto max-h-[400px] text-sm"></pre>
                        <div id="loadingIndicator" class="absolute inset-0 bg-white/80 flex items-center justify-center hidden">
                            <div class="flex flex-col items-center">
                                <div class="w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                                <p class="mt-2 text-primary">请求中...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentApi = null;
        let currentSessionId = null;

        function getAuthFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const auth = params.get('auth');
            document.getElementById('authKey').value = auth || '';
            return auth;
        }

        function getHostFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const host = params.get('host');
            document.getElementById('baseUrl').value = host || 'http://localhost:5000';
            return host;
        }

        function selectApi(apiName) {
            currentApi = apiName;
            const apiParams = document.getElementById('apiParams');
            apiParams.innerHTML = '';
            
            const titles = {
                'getSessions': '获取会话列表',
                'getModels': '获取模型列表',
                'createSession': '创建新会话',
                'getSessionHistory': '获取会话历史',
                'sendMessage': '发送消息'
            };
            document.getElementById('apiTitle').textContent = titles[apiName];
            

            switch(apiName) {
                case 'getSessionHistory':
                    apiParams.innerHTML = `
                        <div>
                            <label class="block text-sm font-medium text-neutral mb-1">sessionId <span class="text-red-500">*</span></label>
                            <input type="text" id="sessionId" value="${currentSessionId || ''}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    `;
                    break;
                    
                case 'sendMessage':
                    apiParams.innerHTML = `
                        <div>
                            <label class="block text-sm font-medium text-neutral mb-1">sessionId <span class="text-red-500">*</span></label>
                            <input type="text" id="sendSessionId" value="${currentSessionId || ''}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-neutral mb-1">消息内容 <span class="text-red-500">*</span></label>
                            <textarea id="messageContent" rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">你好，有什么可以帮助我的吗？</textarea>
                        </div>
                    `;
                    break;
            }
        }

        async function executeApi() {
            if (!currentApi) {
                showResponse('请先选择一个接口', 'error');
                return;
            }
            
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const auth = document.getElementById('authKey').value.trim();
            
            if (!baseUrl) {
                showResponse('请输入API基础地址', 'error');
                return;
            }
            
            if (!auth) {
                showResponse('请在URL中提供auth参数', 'error');
                return;
            }
            
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('responseBody').textContent = '';
            document.getElementById('responseStatus').classList.add('hidden');
            
            try {
                let url = '';
                let method = '';
                let body = null;
                
                switch(currentApi) {
                    case 'getSessions':
                        url = `${baseUrl}/Main/sessions`;
                        method = 'GET';
                        break;
                        
                    case 'getModels':
                        url = `${baseUrl}/Main/models`;
                        method = 'GET';
                        break;
                        
                    case 'createSession':
                        url = `${baseUrl}/Main/sessions`;
                        method = 'POST';
                        break;
                        
                    case 'getSessionHistory':
                        const sessionId = document.getElementById('sessionId').value.trim();
                        if (!sessionId) {
                            showResponse('请输入sessionId', 'error');
                            return;
                        }
                        url = `${baseUrl}/Main/sessions/${sessionId}`;
                        method = 'GET';
                        break;
                        
                    case 'sendMessage':
                        const sendSessionId = document.getElementById('sendSessionId').value.trim();
                        const messageContent = document.getElementById('messageContent').value.trim();
                        if (!sendSessionId) {
                            showResponse('请输入sessionId', 'error');
                            return;
                        }
                        if (!messageContent) {
                            showResponse('请输入消息内容', 'error');
                            return;
                        }
                        url = `${baseUrl}/Main/sessions/${sendSessionId}/messages`;
                        method = 'POST';
                        body = JSON.stringify({ Content: messageContent });
                        break;
                }
                
                const headers = {
                    'Auth': auth,
                    'Content-Type': 'application/json'
                };
                
                const fetchOptions = {
                    method,
                    headers
                };
                
                if (body) {
                    fetchOptions.body = body;
                }
                
                if (currentApi === 'sendMessage') {
                    const response = await fetch(url, fetchOptions);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        showResponse(`HTTP错误: ${response.status} - ${errorText}`, 'error');
                        return;
                    }
                    
                    showResponseStatus(response.status, true);
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let responseText = '';
                    const responseBody = document.getElementById('responseBody');
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        responseText += chunk;
                        responseBody.textContent = responseText;
                        responseBody.scrollTop = responseBody.scrollHeight;
                    }
                    
                    currentSessionId = document.getElementById('sendSessionId').value.trim();
                } 
                else {
                    const response = await fetch(url, fetchOptions);
                    const responseText = await response.text();
                    
                    showResponseStatus(response.status, response.ok);
                    
                    try {
                        const json = JSON.parse(responseText);
                        document.getElementById('responseBody').textContent = JSON.stringify(json, null, 2);
                        
                        if ((currentApi === 'createSession' && json.Id) || 
                            (currentApi === 'getSessions' && json.length > 0)) {
                            currentSessionId = currentApi === 'createSession' ? json.Id : json[0].ID;
                        }
                    } catch (e) {
                        document.getElementById('responseBody').textContent = responseText;
                    }
                }
            } catch (error) {
                showResponse(`请求失败: ${error.message}`, 'error');
            } finally {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        function showResponseStatus(statusCode, isSuccess) {
            const statusEl = document.getElementById('responseStatus');
            statusEl.textContent = `状态码: ${statusCode} ${isSuccess ? '成功' : '失败'}`;
            statusEl.className = `mb-2 px-3 py-1 text-sm rounded inline-block ${isSuccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            statusEl.classList.remove('hidden');
        }

        function showResponse(message, type = 'error') {
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('responseBody').textContent = message;
            
            const statusEl = document.getElementById('responseStatus');
            statusEl.textContent = type === 'error' ? '错误' : '信息';
            statusEl.className = `mb-2 px-3 py-1 text-sm rounded inline-block ${type === 'error' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`;
            statusEl.classList.remove('hidden');
        }

        function copyResponse() {
            const text = document.getElementById('responseBody').textContent;
            if (text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('复制成功');
                }).catch(err => {
                    console.error('复制失败: ', err);
                });
            }
        }

        function clearResponse() {
            document.getElementById('responseBody').textContent = '';
            document.getElementById('responseStatus').classList.add('hidden');
        }

        window.onload = function() {
            getAuthFromUrl();
            getHostFromUrl();
        };
    </script>
</body>
</html>
