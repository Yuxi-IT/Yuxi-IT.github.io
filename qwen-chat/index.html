<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>对话实验</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.chat { height: 72vh; overflow-y: auto; }
.row { display:flex; flex-direction:column; margin:8px 0; }
.leftWrap { align-items:flex-start; }
.rightWrap { align-items:flex-end; }
.bubble {
    max-width:70%;
    padding:10px 14px;
    border-radius:12px;
    white-space:pre-wrap;
}
.left { background:#e0f2fe; }
.right { background:#dcfce7; }
.analysis {
    font-size:12px;
    color:#64748b;
    margin-top:4px;
    max-width:70%;
}
</style>
</head>

<body class="bg-gray-100 p-6">

<h1 class="text-2xl font-bold mb-4">AI 对话实验</h1>

<div class="flex gap-4 mb-4">
    <input id="sessionA" class="border p-2 w-full" placeholder="Session A ID"/>
    <input id="sessionB" class="border p-2 w-full" placeholder="Session B ID"/>
</div>

<div class="flex items-center gap-4 mb-4">
    <label><input type="checkbox" id="autoRun"> 自动运行</label>
    <button id="startBtn" class="bg-blue-500 text-white px-4 py-2 rounded">开始</button>
    <button id="nextBtn" class="bg-green-500 text-white px-4 py-2 rounded hidden">继续</button>
    <button id="clearBtn" class="bg-red-500 text-white px-4 py-2 rounded">清空</button>
</div>

<div id="chat" class="chat bg-white p-4 rounded shadow flex flex-col"></div>

<script>
const auth = new URLSearchParams(location.search).get("auth");
const host = new URLSearchParams(location.search).get("host");

let turn = "A";
let lastMessage = "你好，我们随便聊聊吧。";
let running = false;

const chat = document.getElementById("chat");
const autoRun = document.getElementById("autoRun");
const nextBtn = document.getElementById("nextBtn");
const clearBtn = document.getElementById("clearBtn");

function addMessageBubble(side){
    const wrap = document.createElement("div");
    wrap.className = `row ${side === 'left' ? 'leftWrap' : 'rightWrap'}`;

    const bubble = document.createElement("div");
    bubble.className = `bubble ${side}`;

    const analysis = document.createElement("div");
    analysis.className = "analysis";

    wrap.appendChild(bubble);
    wrap.appendChild(analysis);
    chat.appendChild(wrap);

    chat.scrollTop = chat.scrollHeight;
    return { bubble, analysis };
}

async function streamToBubble(sessionId, content, side){
    const { bubble, analysis } = addMessageBubble(side);

    const res = await fetch(`${host}/Main/sessions/${sessionId}/messages`, {
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "Auth":auth
        },
        body: JSON.stringify({ Content: content })
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder();

    let full = "";

    while(true){
        const {done, value} = await reader.read();
        if(done) break;

        const chunk = decoder.decode(value);
        full += chunk;

        chat.scrollTop = chat.scrollHeight;
    }
    console.log(full);
    return full;
}

async function step(){
    if(running) return;
    running = true;

    const sessionA = document.getElementById("sessionA").value.trim();
    const sessionB = document.getElementById("sessionB").value.trim();

    const currentSession = turn === "A" ? sessionA : sessionB;
    const side = turn === "A" ? "left" : "right";

    const replyVisible = await streamToBubble(currentSession, lastMessage, side);

    lastMessage = replyVisible;
    turn = turn === "A" ? "B" : "A";

    running = false;

    if(autoRun.checked){
        setTimeout(step, 800);
    }else{
        nextBtn.classList.remove("hidden");
    }
}

document.getElementById("startBtn").onclick = () => {
    nextBtn.classList.add("hidden");
    step();
};

nextBtn.onclick = () => {
    nextBtn.classList.add("hidden");
    step();
};

clearBtn.onclick = () => {
    chat.innerHTML = ""; 
    lastMessage = "你好，我们随便聊聊吧。";
    turn = "A";
    nextBtn.classList.add("hidden");
};
</script>

</body>
</html>
