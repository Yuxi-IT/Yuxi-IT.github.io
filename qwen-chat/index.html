<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>å¯¹è¯å®éªŒ</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.chat { height: 72vh; overflow-y: auto; }
.row { display:flex; flex-direction:column; margin:8px 0; }
.leftWrap { align-items:flex-start; }
.rightWrap { align-items:flex-end; }
.bubble {
    max-width:70%;
    padding:10px 14px;
    border-radius:12px;
    white-space:pre-wrap;
}
.left { background:#e0f2fe; }
.right { background:#dcfce7; }
.analysis {
    font-size:12px;
    color:#64748b;
    margin-top:4px;
    max-width:70%;
}
</style>
</head>

<body class="bg-gray-100 p-6">

<h1 class="text-2xl font-bold mb-4">AI å¯¹è¯å®éªŒ</h1>

<div class="flex gap-4 mb-4">
    <input id="sessionA" class="border p-2 w-full" placeholder="Session A ID"/>
    <input id="sessionB" class="border p-2 w-full" placeholder="Session B ID"/>
</div>

<div class="flex items-center gap-4 mb-4">
    <label><input type="checkbox" id="autoRun"> è‡ªåŠ¨è¿è¡Œ</label>
    <button id="startBtn" class="bg-blue-500 text-white px-4 py-2 rounded">å¼€å§‹</button>
    <button id="nextBtn" class="bg-green-500 text-white px-4 py-2 rounded hidden">ç»§ç»­</button>
    <button id="clearBtn" class="bg-red-500 text-white px-4 py-2 rounded">æ¸…ç©º</button>
</div>

<div id="chat" class="chat bg-white p-4 rounded shadow flex flex-col"></div>

<script>
const auth = new URLSearchParams(location.search).get("auth");
const host = new URLSearchParams(location.search).get("host");

let turn = "A";
let lastMessage = "ä½ å¥½ï¼Œæˆ‘ä»¬éšä¾¿èŠèŠå§ã€‚";
let running = false;

const chat = document.getElementById("chat");
const autoRun = document.getElementById("autoRun");
const nextBtn = document.getElementById("nextBtn");
const clearBtn = document.getElementById("clearBtn");

function addMessageBubble(side){
    const wrap = document.createElement("div");
    wrap.className = `row ${side === 'left' ? 'leftWrap' : 'rightWrap'}`;

    const bubble = document.createElement("div");
    bubble.className = `bubble ${side}`;

    const analysis = document.createElement("div");
    analysis.className = "analysis";

    wrap.appendChild(bubble);
    wrap.appendChild(analysis);
    chat.appendChild(wrap);

    chat.scrollTop = chat.scrollHeight;
    return { bubble, analysis };
}

// ğŸ”¥ æ ¸å¿ƒï¼šæ‹†åˆ†æœ€åä¸€è¡Œ
function splitAnalysis(text){
    const lines = text.trim().split("\n");
    if(lines.length <= 1) return { visible:text, analysis:"" };

    const lastLine = lines[lines.length - 1].trim();

    if(lastLine.startsWith("[AIæŒ‡æ•°")){
        return {
            visible: lines.slice(0, -1).join("\n"),
            analysis: lastLine
        };
    }

    return { visible:text, analysis:"" };
}

async function streamToBubble(sessionId, content, side){
    const { bubble, analysis } = addMessageBubble(side);

    const res = await fetch(`${host}/Main/sessions/${sessionId}/messages`, {
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "Auth":auth
        },
        body: JSON.stringify({ Content: content })
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder();

    let full = "";

    while(true){
        const {done, value} = await reader.read();
        if(done) break;

        const chunk = decoder.decode(value);
        full += chunk;

        const { visible, analysis:ana } = splitAnalysis(full);

        bubble.textContent = visible;
        analysis.textContent = ana;

        chat.scrollTop = chat.scrollHeight;
    }

    const finalSplit = splitAnalysis(full);
    return finalSplit.visible; // â—åªæŠŠå¯è§å†…å®¹ä¼ ç»™å¯¹æ–¹
}

async function step(){
    if(running) return;
    running = true;

    const sessionA = document.getElementById("sessionA").value.trim();
    const sessionB = document.getElementById("sessionB").value.trim();

    const currentSession = turn === "A" ? sessionA : sessionB;
    const side = turn === "A" ? "left" : "right";

    const replyVisible = await streamToBubble(currentSession, lastMessage, side);

    lastMessage = replyVisible; // â—å¯¹æ–¹åªæ”¶åˆ°å‰¥ç¦»åçš„å†…å®¹
    turn = turn === "A" ? "B" : "A";

    running = false;

    if(autoRun.checked){
        setTimeout(step, 800);
    }else{
        nextBtn.classList.remove("hidden");
    }
}

document.getElementById("startBtn").onclick = () => {
    nextBtn.classList.add("hidden");
    step();
};

nextBtn.onclick = () => {
    nextBtn.classList.add("hidden");
    step();
};

// æ¸…ç©ºèŠå¤©è®°å½•åŠŸèƒ½
clearBtn.onclick = () => {
    chat.innerHTML = ""; // æ¸…ç©ºèŠå¤©è®°å½•
    lastMessage = "ä½ å¥½ï¼Œæˆ‘ä»¬éšä¾¿èŠèŠå§ã€‚"; // é‡ç½®æ¶ˆæ¯
    turn = "A"; // é‡æ–°ä» A å¼€å§‹
    nextBtn.classList.add("hidden"); // éšè—ç»§ç»­æŒ‰é’®
};
</script>

</body>
</html>
