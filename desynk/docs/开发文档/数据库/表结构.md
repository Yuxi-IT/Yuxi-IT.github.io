# 完整数据库设计文档

## 核心说明
1. 时间戳统一采用**10位秒级UTC+8时间戳**；
2. 字段命名统一为**下划线小写**，枚举值明确注释，补充核心业务约束。

---

## 1. 账户表(account)

### 核心字段
| 字段名            | 类型         | 约束/说明                                                                |
|-------------------|--------------|------------------------------------------------------------------------|
| _id               | TEXT         | 主键(用户ID，自定义唯一标识)                                             |
| type              | TINYINT      | 非空；账户类型：1=个人用户，2=企业用户(支持从1升级为2)                     |
| nickname          | TEXT         | 非空；昵称(个人)/企业名称(企业)                                          |
| password_hash     | TEXT         | 非空；密码哈希值                                                        |
| email             | TEXT         | 唯一、可空；登录邮箱                                                    |
| phone             | TEXT         | 非空；个人手机号/企业法人手机号                                          |
| description       | TEXT         | 非空；个人/企业简介和介绍                                                |
| create_time       | INT          | 非空；注册时间(10位秒级UTC+8时间戳)                                      |
| update_time       | INT          | 非空；最后更新时间(10位秒级UTC+8时间戳)                                  |
| avatar_hash       | TEXT         | 可空；头像文件Hash                                                      |
| credit_score      | UINT         | 非空；默认0；信誉分                                                     |
| session           | ARRAY<DOC>   | 会话状态(在线设备)；结构见下方`Session结构`                              |
| personal_info     | DOC          | 个人身份信息(type=1时必填，type=2时保留)；结构见下方`PersonalInfo结构`    |
| company_info      | DOC          | 企业身份信息(type=2时必填，type=1时为NULL)；结构见下方`CompanyInfo结构`   |
| teams             | ARRAY<TEXT>  | 加入的团队ID列表                                                        |
| recent_published  | ARRAY<TEXT>  | 派单ID列表                                                             |
| recent_contractor | ARRAY<TEXT>  | 接单ID列表(企业账户通常为空)                                             |

### 嵌套结构定义

#### Session结构
| 字段名            | 类型         | 约束/说明                                                                |
|-------------------|--------------|------------------------------------------------------------------------|
| ua                | TEXT         | 非空；登录UA                                                            |
| token             | TEXT         | 非空；长期TOKEN                                                         |
| access_token      | TEXT         | 非空；短期TOKEN                                                         |
| last_login        | INT          | 非空；登录时间(10位UTC+8时间戳)                                          |


#### PersonalInfo结构
| 字段名            | 类型         | 约束/说明                                                                |
|-------------------|--------------|------------------------------------------------------------------------|
| idc               | TEXT         | 可空；身份证号                                                          |
| real_name         | TEXT         | 可空；真实姓名                                                          |
| face_result       | INT          | 非空；默认0；是否完成人脸识别(即实人认证)                                 |
| job_seeking       | UINT         | 非空；默认0；求职状态，0=保密,1=在职,2=学生,3=求职,4=不求职                |
| tech              | ARRAY<TEXT>  | 可空；技术栈信息                                                        |
| work_experience   | ARRAY<DOC>   | 可空；工作经历，格式见下方WorkExperience                                 |
| university        | TEXT         | 可空；毕业院校或在读院校(需完成学生认证)                                  |
| resume            | TEXT         | 可空；简历，通常为Markdown格式                                          |
| wechat            | TEXT         | 可空；微信账户                                                         |
| alipay            | TEXT         | 可空；支付宝账户(邮箱或手机号)                                          |
| bankcard          | TEXT         | 可空；银行卡号                                                         |
| bank              | TEXT         | 可空；银行                                                             |
| bank_of_account   | TEXT         | 可空；开户行                                                           |

#### CompanyInfo结构
| 字段名            | 类型         | 约束/说明                                                                |
|-------------------|--------------|------------------------------------------------------------------------|
| legal_idc         | TEXT         | 非空；法人身份证号                                                      |
| license_hash      | TEXT         | 非空；营业执照Hash                                                      |
| uscc              | TEXT         | 非空；统一社会信用代码                                                   |
| registered_capital| INT          | 可空；注册资金(单位:万)                                                  |
| company_address   | TEXT         | 非空；公司住址                                                          |
| upgrade_time      | INT          | 非空；升级时间                                                          |

```json
{
  "legal_idc": "encrypted_legal_idc_7890",
  "license_hash": "file_hash_license_123",
  "uscc": "xxxxxxxxxxxxxx",
  "company_address": "北京市朝阳区XX大厦",
  "upgrade_time": 1734567890
}
```

---

## 2. 客服表(staff)

| 字段名            | 类型         | 约束/说明  |
|-------------------|--------------|----|
| _id               | TEXT         | 主键(客服工号，自定义唯一标识)                                           |
| password_hash     | TEXT         | 非空；密码哈希值                                                         |
| email             | TEXT         | 唯一、非空；登录邮箱                                                     |
| phone             | TEXT         | 非空；手机号                                                             |
| create_time       | INT          | 非空；创建时间(10位秒级UTC+8时间戳)                                      |
| update_time       | INT          | 非空；最后更新时间(10位秒级UTC+8时间戳)                                  |
| avatar_hash       | TEXT         | 可选；头像文件Hash(关联file表_id)                                        |
| session           | ARRAY<DOC>   | 会话状态(同account表Session结构)                                         |
| praise_count      | UINT         | 非空；默认0；好评数                                                      |
| work_order_ids    | ARRAY<TEXT>  | 处理的工单ID列表                                                         |
| status            | TINYINT      | 非空；默认1；客服状态：1=在职，2=离职                                    |
| is_deleted        | TINYINT      | 非空；默认0；软删除标识：0=正常，1=删除                                  |

---

## 3. 订单表(order)

| 字段名            | 类型         | 约束/说明  |
|-------------------|--------------|----|
| _id               | TEXT         | 主键(订单ID，自定义唯一标识)                                             |
| publisher_id      | TEXT         | 非空；派单用户/企业ID(关联account表_id)                                  |
| contractor_ids    | ARRAY<TEXT>  | 接单方ID列表(个人/多人/团队ID)                                           |
| title             | TEXT         | 非空；订单标题                                                           |
| description       | TEXT         | 非空；订单需求(Markdown格式)                                             |
| price             | DECIMAL(10,2)| 非空；订单价格(元，保留2位小数)                                          |
| create_time       | INT          | 非空；创建时间(10位秒级UTC+8时间戳)                                      |
| deadline          | INT          | 非空；项目截止时间(10位秒级UTC+8时间戳)                                  |
| status            | TINYINT      | 非空；订单状态：-1=已取消，0=未接单，1=未缴定金，2=已接单，3=已完成     |
| group_id          | TEXT         | 可选；对应群聊ID(关联group表_id)                                         |
| contract_time     | INT          | 可选；接单时间(10位秒级UTC+8时间戳，status=1时必填)                      |
| complete_time     | INT          | 可选；完成时间(10位秒级UTC+8时间戳，status=2时必填)                      |
| update_time       | INT          | 非空；最后更新时间(10位秒级UTC+8时间戳)                                  |
| is_deleted        | TINYINT      | 非空；默认0；软删除标识：0=正常，1=删除                                  |

---

## 4. 群聊表(group)

| 字段名            | 类型         | 约束/说明  |
|-------------------|--------------|----|
| _id               | TEXT         | 主键；复用订单ID                                                         |
| name              | TEXT         | 非空；群聊名                                                             |
| creator_id        | TEXT         | 非空；创建者ID(关联account表_id)                                         |
| member_ids        | ARRAY<TEXT>  | 非空；群成员ID列表(account/staff表_id)                                   |
| create_time       | INT          | 非空；创建时间(10位秒级UTC+8时间戳)                                      |
| update_time       | INT          | 非空；最后更新时间(10位秒级UTC+8时间戳)                                  |
| is_deleted        | TINYINT      | 非空；默认0；软删除标识：0=正常，1=删除                                  |
| is_frozen         | TINYINT      | 非空；默认0；群聊冻结标识：0=正常，1=项目结束冻结（禁止发消息）          |

### Group表Demo JSON
```json
{
  "_id": "group_8888",
  "name": "XX项目对接群",
  "creator_id": "account_123",
  "member_ids": ["account_123", "account_456", "staff_789"],
  "create_time": 1734307200,
  "update_time": 1734567890,
  "is_deleted": 0,
  "is_frozen": 0
}
```

---

## 5. 群聊消息表(group_message)

| 字段名    | 类型 | 约束/说明 |
|-----------|------|----------|
| _id       | TEXT | 主键，等于 `group._id` |
| messages  | DOC  | 消息容器，按 `YYYYMMDD` 日期分块存储所有消息 |

### 消息结构说明
- `messages` 字段为一个对象，其键为 `YYYYMMDD` 格式的日期字符串；
- 每个日期键对应的值为一个**消息对象数组**；
- 每条消息对象包含以下字段：

| 字段名             | 类型    | 约束/说明 |
|--------------------|---------|----------|
| sender_id          | TEXT    | 非空；发送方ID（account/staff表_id） |
| msg_type           | TINYINT | 非空；消息类型：1=文本，2=Markdown，3=文件，4=图片，5=视频，6=预算申请 |
| content            | TEXT    | 可选；文本/Markdown内容(msg_type=1/2时必填；3-5时存file表_hash；6时存budget表_id) |
| send_time          | INT     | 非空；发送时间(10位秒级UTC+8时间戳) |
| referenced_msg_id  | TEXT    | 可选；引用的消息ID(无引用则为NULL) |
| is_withdraw        | TINYINT | 非空；默认0；软撤回标识：0=正常，1=撤回 |

### Group Message表Demo JSON
```json
{
  "_id": "group_8888",
  "messages": {
    "20251217": [
      {
        "sender_id": "account_123",
        "msg_type": 1,
        "content": "项目进度更新：已完成需求分析",
        "send_time": 1734567890,
        "referenced_msg_id": null,
        "is_withdraw": 0
      }
    ]
  }
}
```

---

## 6. 存档的群聊消息表(archive_group_message)

| 字段名    | 类型 | 约束/说明 |
|-----------|------|----------|
| _id       | TEXT | 主键，等于 `group._id` |
| messages  | DOC  | 消息容器，按 `YYYYMMDD` 日期分块存储所有消息 |

### 消息结构说明
- `messages` 字段为一个对象，其键为 `YYYYMMDD` 格式的日期字符串；
- 每个日期键对应的值为一个**消息对象数组**；
- 每条消息对象包含以下字段：

| 字段名             | 类型    | 约束/说明 |
|--------------------|---------|----------|
| sender_id          | TEXT    | 非空；发送方ID（account/staff表_id） |
| msg_type           | TINYINT | 非空；消息类型：1=文本，2=Markdown，3=文件，4=图片，5=视频，6=预算申请 |
| content            | TEXT    | 可选；文本/Markdown内容(msg_type=1/2时必填；3-5时存file表_hash；6时存budget表_id) |
| send_time          | INT     | 非空；发送时间(10位秒级UTC+8时间戳) |
| referenced_msg_id  | TEXT    | 可选；引用的消息ID(无引用则为NULL) |
| is_withdraw        | TINYINT | 非空；默认0；软撤回标识：0=正常，1=撤回 |
| archive_time       | INT     | 非空；存档时间(10位秒 级UTC+8时间戳) |


---

## 7. 文件表(file)

| 字段名            | 类型         | 约束/说明  |
|-------------------|--------------|----|
| _id               | TEXT         | 主键(文件Hash，唯一标识)                                                 |
| name              | TEXT         | 非空；文件名                                                             |
| uploader_id       | TEXT         | 非空；上传者ID(account/staff表_id)                                       |
| file_type         | TEXT         | 非空；文件类型(如image/jpeg、video/mp4、application/pdf)                 |
| size              | BIGINT       | 非空；文件大小(字节)                                                     |
| access_type       | TINYINT      | 非空；权限类型：1=公开，2=团队，3=指定用户，4=指定群聊                   |
| team_id           | TEXT         | 可选；关联团队ID(仅access_type=2时必填，team表_id)                       |
| visitor_targets   | ARRAY<DOC>   | 可选；访问目标列表(access_type=3/4时必填)；结构见下方`VisitorTargets结构` |
| upload_time       | INT          | 非空；上传时间(10位秒级UTC+8时间戳)                                      |
| expire_time       | INT          | 可选；过期时间(10位秒级UTC+8时间戳，NULL=永久)                           |
| update_time       | INT          | 非空；最后更新时间(10位秒级UTC+8时间戳)                                  |
| is_deleted        | TINYINT      | 非空；默认0；软删除标识：0=正常，1=删除                                  |

### 嵌套结构定义

#### VisitorTargets结构
```json
[
  {
    "target_type": 1,
    "target_id": "account_123"
  },
  {
    "target_type": 2,
    "target_id": "group_8888"
  }
]
```

> `target_type` 说明：1=用户(account)，2=群聊(group)

### File表Demo JSON
```json
{
  "_id": "file_hash_12345",
  "name": "项目需求文档.pdf",
  "uploader_id": "account_123",
  "file_type": "application/pdf",
  "size": 102400,
  "access_type": 4,
  "team_id": null,
  "visitor_targets": [
    {
      "target_type": 2,
      "target_id": "group_8888"
    }
  ],
  "upload_time": 1734500000,
  "expire_time": null,
  "update_time": 1734500000,
  "is_deleted": 0
}
```

---

## 8. 团队表(team)

| 字段名            | 类型         | 约束/说明  |
|-------------------|--------------|----|
| _id               | TEXT         | 主键(团队ID，自定义唯一标识)                                             |
| name              | TEXT         | 非空；团队名                                                             |
| creator_id        | TEXT         | 非空；创建者ID(account表_id)                                             |
| member_ids        | ARRAY<TEXT>  | 非空；团队成员ID列表(account表_id)                                       |
| description       | TEXT         | 可选；团队描述                                                           |
| tags              | ARRAY<TEXT>  | 可选；团队技术栈标签                                                     |
| recent_contractor | ARRAY<TEXT>  | 可选；接单ID列表(order表_id)                                             |
| status            | TINYINT      | 非空；默认1；团队状态：1=正常，2=解散                                    |
| create_time       | INT          | 非空；创建时间(10位秒级UTC+8时间戳)                                      |
| update_time       | INT          | 非空；最后更新时间(10位秒级UTC+8时间戳)                                  |
| is_deleted        | TINYINT      | 非空；默认0；软删除标识：0=正常，1=删除                                  |

### Team表Demo JSON
```json
{
  "_id": "team_6666",
  "name": "研发团队A",
  "creator_id": "account_456",
  "member_ids": ["account_456", "account_789"],
  "description": "负责后端开发",
  "tags": ["Java", "SpringBoot"],
  "recent_contractor": ["order_9999"],
  "status": 1,
  "create_time": 1734000000,
  "update_time": 1734500000,
  "is_deleted": 0
}
```

---

## 9. 预算申请表(budget)

| 字段名            | 类型         | 约束/说明  |
|-------------------|--------------|----|
| _id               | TEXT         | 主键(预算申请ID，自定义唯一标识)                                         |
| group_id          | TEXT         | 非空；关联群聊ID(group表_id)                                             |
| order_id          | TEXT         | 非空；关联订单ID(order表_id)                                             |
| initiator_id      | TEXT         | 非空；发起者ID(account表_id)                                             |
| title             | TEXT         | 非空；申请标题                                                           |
| wallet            | INT          | 非空；收款方式 1=wechat,2=alipay,3=bank                                  |
| amount            | DECIMAL(10,2)| 非空；申请金额(元，保留2位小数)                                          |
| state             | TINYINT      | 非空；申请状态：-1=已拒绝，0=待审核，1=已通过，2=已撤销                  |
| audit_staff_id    | TEXT         | 可选；审核人ID(staff表_id，state=-1/1时必填)                             |
| reject_reason     | TEXT         | 可选；拒绝原因(state=-1时必填)                                           |
| image_hashes      | ARRAY<TEXT>  | 可选；申请预算上传的图片Hash列表(关联file表_id)                          |
| create_time       | INT          | 非空；创建时间(10位秒级UTC+8时间戳)                                      |
| audit_time        | INT          | 可选；审核时间(10位秒级UTC+8时间戳，state=-1/1时必填)                    |
| update_time       | INT          | 非空；最后更新时间(10位秒级UTC+8时间戳)                                  |

### Budget表Demo JSON
```json
{
  "_id": "budget_5555",
  "group_id": "group_8888",
  "order_id": "order_9999",
  "initiator_id": "account_123",
  "title": "项目开发预算申请",
  "wallet": 1,
  "amount": 50000.00,
  "state": 1,
  "audit_staff_id": "staff_789",
  "reject_reason": null,
  "image_hashes": ["file_hash_67890"],
  "create_time": 1734400000,
  "audit_time": 1734450000,
  "update_time": 1734450000
}
```

---

## 索引设计

| 集合名          | 索引字段                          | 索引类型   | 说明                     |
|------------------|-----------------------------------|------------|--------------------------|
| account          | email: 1                          | 唯一索引   | 登录时快速查询用户       |
| account          | phone: 1                          | 唯一索引   | 手机号快速检索           |
| account          | type: 1, credit_score: -1         | 普通索引   | 按账户类型+信誉分排序    |
| order            | publisher_id: 1, status: 1        | 复合索引   | 按派单人+订单状态查询    |
| order            | create_time: -1                   | 普通索引   | 按创建时间倒序查最新订单 |
| group            | member_ids: 1                     | 数组索引   | 按成员ID查所属群聊       |
| group            | is_frozen: 1, update_time: -1     | 复合索引   | 按冻结状态+更新时间查询  |
| group_message    | _id: 1                            | 主键索引   | 按群ID查询聊天记录（1次IO） |
| file             | uploader_id: 1, access_type: 1    | 复合索引   | 按上传者+权限类型查文件  |
| budget           | initiator_id: 1, state: 1         | 复合索引   | 按申请人+状态查预算申请  |

---