(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[340],{2649:(e,t,a)=>{Promise.resolve().then(a.bind(a,918))},918:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>m});var c=a(5155),n=a(5654),r=a(4350),s=a(3947),l=a(2026),o=a(3038),i=a(2935),d=a(6743),h=a(7478),u=a(9895);function m(){let{clients:e,loading:t,error:a,connectedClientId:m,connectToClient:x,disconnectClient:N}=(0,n.h)(),S=e=>{m===e?N():m||x(e)};return(0,c.jsxs)("div",{className:"w-full overflow-x-auto",children:[(0,c.jsx)("h1",{className:"text-xl font-bold mb-4",children:"客户端列表"}),t&&(0,c.jsx)("div",{className:"p-4 text-center",children:"正在连接服务器..."}),a&&(0,c.jsx)("div",{className:"p-4 text-center text-red-500",children:a}),(0,c.jsx)("div",{className:"w-full max-w-full overflow-hidden",children:(0,c.jsxs)(r.j,{"aria-label":"客户端列表",className:"w-full",children:[(0,c.jsxs)(s.X,{children:[(0,c.jsx)(l.e,{children:"设备名称"}),(0,c.jsx)(l.e,{className:"max-md:hidden",children:"IP地址"}),(0,c.jsx)(l.e,{className:"max-md:hidden",children:"用户名"}),(0,c.jsx)(l.e,{className:"max-md:hidden",children:"系统版本"}),(0,c.jsx)(l.e,{children:"连接时间"}),(0,c.jsx)(l.e,{children:"连接人数"}),(0,c.jsx)(l.e,{children:"操作"})]}),(0,c.jsx)(o.E,{children:e.map(e=>(0,c.jsxs)(i.s,{children:[(0,c.jsx)(d.w,{children:e.deviceName}),(0,c.jsxs)(d.w,{className:"max-md:hidden",children:[e.ip,":",e.port]}),(0,c.jsx)(d.w,{className:"max-md:hidden",children:e.userName}),(0,c.jsx)(d.w,{className:"max-md:hidden",children:e.version}),(0,c.jsx)(d.w,{children:e.time?new Date(e.time).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).replace(/\//g,"-"):"N/A"}),(0,c.jsx)(d.w,{children:e.count}),(0,c.jsx)(d.w,{children:(0,c.jsx)(h.T,{isIconOnly:!0,onClick:()=>S(e.id),"aria-label":m===e.id?"disconnect":"connect",variant:"faded",isDisabled:!!m&&m!==e.id,children:(0,c.jsx)(u.W,{src:m===e.id?"/disc.png":"/connect.png",alt:m===e.id?"断开连接":"连接"})})})]},e.id))})]})})]})}},5654:(e,t,a)=>{"use strict";a.d(t,{WebSocketProvider:()=>l,h:()=>s});var c=a(5155),n=a(2115);let r=(0,n.createContext)(void 0);function s(){let e=(0,n.useContext)(r);if(!e)throw Error("useWebSocket 必须在 WebSocketProvider 内部使用");return e}function l(e){let{children:t}=e,[a,s]=(0,n.useState)([]),[l,o]=(0,n.useState)(null),[i,d]=(0,n.useState)(!0),[h,u]=(0,n.useState)(""),[m,x]=(0,n.useState)(null),[N,S]=(0,n.useState)(""),[f,w]=(0,n.useState)([]),b=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];S(a=>t?"".concat(a).concat(e):e)},j=async()=>{try{let e=localStorage.getItem("serverapi"),t=localStorage.getItem("serverkey");if(!e||!t)throw Error("请先设置服务器API地址和密钥");let a=await fetch("http://".concat(e,"/api/auth/build?key=").concat(t)),c=await a.json();if(200!==c.code||!c.data)throw Error("获取TOKEN失败");return c.data}catch(e){throw u(e instanceof Error?e.message:"获取TOKEN时发生错误"),e}},k=async e=>{try{let t=await j();e.send("AUTH\n".concat(t))}catch(e){console.error("获取token失败:",e),u("获取验证token失败")}},g=async()=>{if(!l||l.readyState!==WebSocket.OPEN){u("WebSocket连接未就绪");return}d(!0),await k(l),d(!1)},y=(0,n.useCallback)(e=>{if(!l||l.readyState!==WebSocket.OPEN){u("WebSocket连接未就绪");return}x(e),l.send("CONNECT\n".concat(e)),console.log("请求连接客户端: ".concat(e))},[l]),E=(0,n.useCallback)(()=>{if(!l||l.readyState!==WebSocket.OPEN){u("WebSocket连接未就绪");return}m&&(l.send("DISCONNECT\n".concat(m)),console.log("断开连接客户端: ".concat(m))),x(null)},[l,m]),p=e=>{w(e.split("\\n").map(e=>{let t=e.split("|");if(t.length>=3){let[e,a,c]=t;return{name:e,time:a,type:"DIR"===c?"DIR":"FILE"}}return null}).filter(e=>null!==e))};return(0,n.useEffect)(()=>{let e=async()=>{let t=localStorage.getItem("serveraddress");if(!t){u("请先在设置中配置服务器地址"),d(!1);return}try{d(!0);let a=new WebSocket("ws://".concat(t));a.onopen=async()=>{console.log("WebSocket 连接已建立");try{let e=await j();a.send("AUTH\n".concat(e))}catch(e){u(e instanceof Error?e.message:"认证失败")}},a.onmessage=e=>{try{let t=JSON.parse(e.data);switch(console.log("接收到消息:",t),t.type){case"CLIENTS":Array.isArray(t.data)?s(t.data):s([t.data]);break;case"CONNECTION_STATUS":x(t.connected?t.clientId:null);break;case"ERROR":u(t.message);break;case"SHELL":b(t.data+"\n",!0);break;case"FILES":p(t.data);break;default:console.warn("未知消息类型:",t.type)}}catch(t){console.error("消息解析失败:",e.data)}},a.onerror=e=>{u("WebSocket 错误: ".concat(e))},a.onclose=t=>{1e3!==t.code&&setTimeout(e,3e3)},o(a)}catch(e){u("连接失败: ".concat(e))}finally{d(!1)}};e()},[]),(0,c.jsx)(r.Provider,{value:{clients:a,loading:i,error:h,ws:l,connectedClientId:m,shellLog:N,fileList:f,setshellLog:b,connectToClient:y,disconnectClient:E,refreshClients:g},children:t})}}},e=>{var t=t=>e(e.s=t);e.O(0,[966,628,50,427,441,517,358],()=>t(2649)),_N_E=e.O()}]);